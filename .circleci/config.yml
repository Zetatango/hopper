version: 2
jobs:
  build:
    parallelism: 2
    working_directory: ~/hopper
    environment:
      - CODECOV_TOKEN: ae4725f0-0117-4707-bc6a-b442b24131cb
    docker:
      - image: circleci/ruby:2.5.3

    steps:
      - checkout

      - run:
          name: Bundle Install
          command: bundle install

      - run:
          name: Run rubocop
          command: |
            bundle exec rubocop --out test_results/rubocop.txt --format fuubar --require rubocop-rspec --config .rubocop.yml

      - run:
          name: Run bundle-audit
          command: |
            bundle exec bundle-audit check --update

      - run:
          name: Run rspec tests
          command: |
            bundle exec rspec \
              --profile 10 \
              --format RspecJunitFormatter \
              --out test_results/rspec.xml \
              --format progress

      - store_test_results:
          path: test_results

      - store_artifacts:
          path: test_results
          prefix: tests

      - store_artifacts:
          path: coverage
          prefix: coverage
